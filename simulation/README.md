# SDFç¢°æ’æ£€æµ‹ä¸ä¿®å¤

æœ¬ç›®å½•åŒ…å«ä½¿ç”¨Signed Distance Field (SDF)æ–¹æ³•æ£€æµ‹å’Œè§£å†³meshç©¿æ¨¡é—®é¢˜çš„å·¥å…·ã€‚

## ğŸ“ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶
- **`sdf_collision_resolver.py`** - æ ‡å‡†ç‰ˆæœ¬ï¼šç²¾ç¡®ä½†è¾ƒæ…¢ï¼ˆé€‚åˆé«˜ç²¾åº¦éœ€æ±‚ï¼‰
- **`sdf_collision_resolver_fast.py`** - âš¡ **å¿«é€Ÿç‰ˆæœ¬ï¼šæ¨èä½¿ç”¨ï¼é€Ÿåº¦æå‡10-50å€**
- **`simulation.md`** - è¯¦ç»†çš„åŸç†è¯´æ˜æ–‡æ¡£
- **`requirements.txt`** - Pythonä¾èµ–åŒ…åˆ—è¡¨

### è¿è¡Œè„šæœ¬
- **`run_fast.sh`** - âš¡ **æ­¥éª¤1ï¼šå¿«é€Ÿç‰ˆæœ¬è„šæœ¬ï¼ˆæ¨èï¼‰**
- **`run_fix_small.sh`** - ğŸ”§ **æ­¥éª¤2ï¼šå°ç‰©ä»¶ç²¾ç»†åŒ–ä¿®å¤**
- **`run_collision_detection.sh`** - æ ‡å‡†ç‰ˆæœ¬è„šæœ¬ï¼ˆç²¾ç¡®ä½†æ…¢ï¼‰

### å·¥å…·
- **`fix_small_objects.py`** - å°ç‰©ä»¶ä¸“ç”¨ä¿®å¤å·¥å…·
- **`visualize_comparison.py`** - å¯¹æ¯”å¯è§†åŒ–å·¥å…·
- **`README.md`** - æœ¬æ–‡ä»¶

## âš¡ ä¸¤ä¸ªç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | æ ‡å‡†ç‰ˆ (sdf_collision_resolver.py) | å¿«é€Ÿç‰ˆ (sdf_collision_resolver_fast.py) |
|------|-----------------------------------|----------------------------------------|
| **é€Ÿåº¦** | æ…¢ï¼ˆ65ä¸ªmeshéœ€30-60åˆ†é’Ÿï¼‰ | âš¡ å¿«ï¼ˆ65ä¸ªmeshä»…éœ€2-5åˆ†é’Ÿï¼‰ |
| **ç²¾åº¦** | é«˜ï¼ˆä½“ç´ åŒ–SDFï¼Œç²¾ç¡®è®¡ç®—ï¼‰ | ä¸­ï¼ˆé‡‡æ ·ç‚¹+KDæ ‘ï¼Œè¿‘ä¼¼è®¡ç®—ï¼‰ |
| **å†…å­˜** | é«˜ï¼ˆéœ€ç¼“å­˜å¤§é‡SDFç½‘æ ¼ï¼‰ | ä½ï¼ˆä»…ç¼“å­˜KDæ ‘ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | é«˜ç²¾åº¦éœ€æ±‚ã€å°åœºæ™¯ | å¤§åœºæ™¯ã€å¿«é€Ÿé¢„è§ˆã€å®æ—¶è°ƒæ•´ |
| **æ¨èåº¦** | â­â­â­ | â­â­â­â­â­ |

**ğŸ’¡ å»ºè®®**ï¼šå…ˆç”¨å¿«é€Ÿç‰ˆæœ¬æ£€æµ‹å’Œåˆæ­¥ä¿®å¤ï¼Œå¦‚éœ€æ›´ç²¾ç¡®çš„ç»“æœå†ç”¨æ ‡å‡†ç‰ˆæœ¬ç²¾ä¿®ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# å¦‚æœä½¿ç”¨condaç¯å¢ƒ
conda activate instascene

# å®‰è£…ä¾èµ–åŒ…
pip install -r requirements.txt
```

### 2. æ¨èçš„ä¸¤æ­¥å·¥ä½œæµç¨‹ â­

#### æ­¥éª¤1ï¼šå¿«é€Ÿä¿®å¤å¤§ç‰©ä»¶ï¼ˆ2-5åˆ†é’Ÿï¼‰

```bash
./run_fast.sh
```

è¿™ä¼šå¤„ç†å¤§éƒ¨åˆ†ç©¿æ¨¡é—®é¢˜ï¼Œç”Ÿæˆ `world_mesh_fixed/`

#### æ­¥éª¤2ï¼šç²¾ç»†ä¿®å¤å°ç‰©ä»¶ï¼ˆ1-3åˆ†é’Ÿï¼‰

```bash
./run_fix_small.sh
```

è¿™ä¼šä¸“é—¨å¤„ç†æ¯å­ç­‰å°ç‰©ä»¶çš„ç©¿æ¨¡ï¼Œç”Ÿæˆæœ€ç»ˆç»“æœ `world_mesh_final/`

**å®Œæˆï¼** æ€»è€—æ—¶çº¦ **3-8åˆ†é’Ÿ**ï¼Œç»“æœä¿å­˜åœ¨ `world_mesh_final/`

---

### 3. æ‰‹åŠ¨è¿è¡Œï¼ˆå¯é€‰ï¼‰

#### å¿«é€Ÿç‰ˆæœ¬

```bash
# æ­¥éª¤1ï¼šåˆæ­¥ä¿®å¤
python sdf_collision_resolver_fast.py \
    --input_dir ../world_mesh \
    --output_dir ../world_mesh_fixed \
    --sample_points 500 \
    --iterations 50

# æ­¥éª¤2ï¼šå°ç‰©ä»¶ç²¾ä¿®
python fix_small_objects.py \
    --input_dir ../world_mesh_fixed \
    --output_dir ../world_mesh_final \
    --tolerance 0.005 \
    --size_threshold 0.3 \
    --dense_samples 2000
```

#### æ ‡å‡†ç‰ˆæœ¬ï¼ˆé«˜ç²¾åº¦ä½†æ…¢ï¼‰

```bash
# ä»…æ£€æµ‹ï¼ˆéœ€è¦15-30åˆ†é’Ÿï¼‰
python sdf_collision_resolver.py \
    --input_dir ../world_mesh \
    --detect_only \
    --resolution 64

# ä¿®å¤ï¼ˆéœ€è¦30-60åˆ†é’Ÿï¼‰
python sdf_collision_resolver.py \
    --input_dir ../world_mesh \
    --output_dir ../world_mesh_fixed \
    --method projection \
    --resolution 64 \
    --iterations 50
```

## ğŸ”§ å°ç‰©ä»¶ä¿®å¤è¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦å°ç‰©ä»¶ä¸“ç”¨ä¿®å¤ï¼Ÿ

å°ç‰©ä»¶ï¼ˆå¦‚æ¯å­ã€ç“¶å­ç­‰ï¼‰çš„ç‰¹ç‚¹ï¼š
- **å°ºå¯¸å°**ï¼šé€šå¸¸ < 0.3m
- **è¡¨é¢ç§¯å°**ï¼šç”¨500ä¸ªé‡‡æ ·ç‚¹ä¸å¤Ÿå¯†é›†
- **é—´è·å°**ï¼šå½¼æ­¤é å¾—å¾ˆè¿‘ï¼Œå®¹æ˜“ç©¿æ¨¡

### å°ç‰©ä»¶ä¿®å¤çš„ä¼˜åŒ–

1. **è‡ªé€‚åº”é‡‡æ ·**ï¼š
   - å¤§ç‰©ä»¶ï¼š500ä¸ªé‡‡æ ·ç‚¹
   - å°ç‰©ä»¶ï¼š2000ä¸ªé‡‡æ ·ç‚¹ï¼ˆ4å€å¯†åº¦ï¼ï¼‰

2. **æ›´ä¸¥æ ¼çš„å®¹å¿åº¦**ï¼š
   - æ ‡å‡†ï¼š0.01m
   - å°ç‰©ä»¶ï¼š0.005mï¼ˆ2å€ä¸¥æ ¼ï¼‰

3. **ä¼˜å…ˆçº§å¤„ç†**ï¼š
   - ä¼˜å…ˆæ£€æµ‹å’Œä¿®å¤å°ç‰©ä»¶ä¹‹é—´çš„ç¢°æ’
   - å¯¹å°ç‰©ä»¶ä½¿ç”¨æ›´æ¿€è¿›çš„åˆ†ç¦»ç­–ç•¥

### å‚æ•°è°ƒæ•´å»ºè®®

å¦‚æœå°ç‰©ä»¶ä»æœ‰ç©¿æ¨¡ï¼Œå¯ä»¥è°ƒæ•´ï¼š

```bash
python fix_small_objects.py \
    --input_dir ../world_mesh_fixed \
    --output_dir ../world_mesh_final \
    --tolerance 0.003 \          # æ›´ä¸¥æ ¼ï¼ˆé»˜è®¤0.005ï¼‰
    --size_threshold 0.4 \       # æ›´å¤§çš„å°ºå¯¸é˜ˆå€¼ï¼ˆé»˜è®¤0.3ï¼‰
    --dense_samples 3000 \       # æ›´å¤šé‡‡æ ·ç‚¹ï¼ˆé»˜è®¤2000ï¼‰
    --iterations 150             # æ›´å¤šè¿­ä»£ï¼ˆé»˜è®¤100ï¼‰
```

## ğŸ“Š å‚æ•°è¯´æ˜

### å¿…é€‰å‚æ•°

- `--input_dir PATH` - è¾“å…¥meshç›®å½•ï¼ˆåŒ…å«.glbæ–‡ä»¶ï¼‰
- `--output_dir PATH` - è¾“å‡ºç›®å½•ï¼ˆä¿®å¤åçš„meshï¼‰

### å¯é€‰å‚æ•°

- `--resolution N` - SDFç½‘æ ¼åˆ†è¾¨ç‡ï¼ˆé»˜è®¤64ï¼‰
  - `64`: å¿«é€Ÿï¼Œé€‚åˆåˆæ­¥æµ‹è¯•
  - `128`: å¹³è¡¡ï¼Œæ¨èä½¿ç”¨
  - `256`: é«˜ç²¾åº¦ï¼Œä½†è®¡ç®—æ…¢

- `--tolerance FLOAT` - ç©¿é€å®¹å¿é˜ˆå€¼ï¼Œå•ä½ç±³ï¼ˆé»˜è®¤0.01ï¼‰
  - å°äºæ­¤å€¼çš„ç©¿é€ä¼šè¢«å¿½ç•¥

- `--method {physical,projection}` - ç¢°æ’è§£å†³æ–¹æ³•
  - `projection`: ç›´æ¥æŠ•å½±åˆ†ç¦»ï¼ˆå¿«é€Ÿï¼Œæ¨èï¼‰
  - `physical`: ç‰©ç†ä»¿çœŸï¼ˆæ›´çœŸå®ä½†æ…¢ï¼‰

- `--iterations N` - æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤100ï¼‰

- `--max_meshes N` - é™åˆ¶åŠ è½½meshæ•°é‡ï¼ˆ0=å…¨éƒ¨ï¼‰
  - ç”¨äºå¿«é€Ÿæµ‹è¯•

- `--detect_only` - ä»…æ£€æµ‹ä¸ä¿®å¤

- `--verbose` - è¯¦ç»†æ—¥å¿—è¾“å‡º

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¿«é€Ÿæµ‹è¯•ï¼ˆå‰10ä¸ªmeshï¼‰

```bash
python sdf_collision_resolver.py \
    --input_dir ../world_mesh \
    --detect_only \
    --max_meshes 10 \
    --resolution 64
```

### ç¤ºä¾‹2ï¼šé«˜ç²¾åº¦ä¿®å¤

```bash
python sdf_collision_resolver.py \
    --input_dir ../world_mesh \
    --output_dir ../world_mesh_fixed \
    --method projection \
    --resolution 128 \
    --tolerance 0.005 \
    --iterations 100
```

### ç¤ºä¾‹3ï¼šç‰©ç†ä»¿çœŸæ–¹æ³•

```bash
python sdf_collision_resolver.py \
    --input_dir ../world_mesh \
    --output_dir ../world_mesh_fixed \
    --method physical \
    --resolution 64 \
    --iterations 200
```

## ğŸ“ˆ æ€§èƒ½å‚è€ƒ

åœ¨æ™®é€šå·¥ä½œç«™ä¸Šçš„å¤§è‡´è€—æ—¶ï¼ˆæ¯ä¸ªmeshçº¦10Ké¢ç‰‡ï¼‰ï¼š

| Meshæ•°é‡ | åˆ†è¾¨ç‡ | æ£€æµ‹æ—¶é—´ | ä¿®å¤æ—¶é—´ |
|---------|--------|---------|---------|
| 10      | 64Â³    | ~30ç§’   | ~1åˆ†é’Ÿ  |
| 20      | 64Â³    | ~2åˆ†é’Ÿ  | ~3åˆ†é’Ÿ  |
| 50      | 64Â³    | ~10åˆ†é’Ÿ | ~15åˆ†é’Ÿ |
| 10      | 128Â³   | ~3åˆ†é’Ÿ  | ~5åˆ†é’Ÿ  |

## ğŸ“– åŸç†è¯´æ˜

è¯¦ç»†çš„ç®—æ³•åŸç†å’Œæ•°å­¦æ¨å¯¼è¯·å‚é˜…ï¼š**[simulation.md](simulation.md)**

æ ¸å¿ƒæ€æƒ³ï¼š
1. ä¸ºæ¯ä¸ªmeshæ„å»ºSDFï¼ˆæœ‰å‘è·ç¦»åœºï¼‰
2. é€šè¿‡SDFæ£€æµ‹meshä¹‹é—´çš„ç©¿é€
3. ä½¿ç”¨ä¼˜åŒ–æˆ–ç‰©ç†ä»¿çœŸè°ƒæ•´ä½ç½®æ¶ˆé™¤ç©¿é€

## ğŸ”§ è¾“å‡ºæ–‡ä»¶

ä¿®å¤åçš„è¾“å‡ºç›®å½•åŒ…å«ï¼š

```
world_mesh_fixed/
â”œâ”€â”€ instance_12_refine_world.glb    # ä¿®å¤åçš„mesh
â”œâ”€â”€ instance_13_refine_world.glb
â”œâ”€â”€ ...
â””â”€â”€ transforms.json                  # è®°å½•äº†æ¯ä¸ªmeshçš„å˜æ¢ä¿¡æ¯
```

`transforms.json` æ ¼å¼ï¼š
```json
{
  "instance_12_refine_world.glb": {
    "instance_id": 12,
    "position": [x, y, z],
    "rotation": [[r11, r12, r13], [r21, r22, r23], [r31, r32, r33]]
  }
}
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šSDFè®¡ç®—å¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é™ä½åˆ†è¾¨ç‡ï¼š`--resolution 32`
- é™åˆ¶meshæ•°é‡ï¼š`--max_meshes 10`
- æ£€æŸ¥meshæ˜¯å¦è¿‡äºå¤æ‚ï¼ˆé¢ç‰‡æ•°>100Kï¼‰

### é—®é¢˜2ï¼šä¿®å¤åä»æœ‰ç©¿æ¨¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¢åŠ è¿­ä»£æ¬¡æ•°ï¼š`--iterations 200`
- æé«˜ç²¾åº¦ï¼š`--resolution 128`
- é™ä½å®¹å¿åº¦ï¼š`--tolerance 0.005`
- å°è¯•ç‰©ç†æ–¹æ³•ï¼š`--method physical`

### é—®é¢˜3ï¼šmeshä¿®å¤åä½ç½®åç§»å¤ªå¤§

**åŸå› **ï¼šåˆå§‹ç©¿æ¨¡å¤ªä¸¥é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å…ˆç”¨ä½ç²¾åº¦å¿«é€Ÿåˆ†ç¦»ï¼š`--resolution 32 --iterations 20`
- å†ç”¨é«˜ç²¾åº¦ç²¾ä¿®ï¼š`--resolution 128`

### é—®é¢˜4ï¼šå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é™ä½åˆ†è¾¨ç‡
- åˆ†æ‰¹å¤„ç†mesh
- ä½¿ç”¨`--max_meshes`å‚æ•°

## ğŸ“š æ‰©å±•é˜…è¯»

- [Signed Distance Field - Wikipedia](https://en.wikipedia.org/wiki/Signed_distance_function)
- [Trimesh Documentation](https://trimsh.org/)
- [collision detection algorithms](https://en.wikipedia.org/wiki/Collision_detection)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æå‡ºé—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

---

**ä½œè€…**: AI Assistant  
**æ—¥æœŸ**: 2026-01-18  
**ç‰ˆæœ¬**: 1.0
